{% extends "base.html" %}

{% block title %}Register - Secure Voting System{% endblock %}

{% block content %}
<!--
REGISTRATION PAGE TEMPLATE
=========================

HOW THIS PAGE WORKS:
- Provides user registration interface for new voters
- Validates password strength and username uniqueness
- Creates secure user accounts with encrypted passwords
- Guides users through the registration process
- Ensures compliance with voting system security standards

CONNECTIONS TO OTHER PAGES:
- Extends base.html for consistent styling and navigation
- Submits registration data to app.py register route via POST
- Redirects to login.html upon successful registration
- Links back to login.html for existing users
- Connected to home.html through navigation

SECURITY FEATURES:
- Password strength validation on client and server side
- Username uniqueness checking
- Password confirmation verification
- Secure password hashing with bcrypt
- Clear security requirements display
-->

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">
            <!-- Registration Card -->
            <div class="flag-card">
                <!-- Header Section -->
                <div class="text-center mb-4">
                    <div class="flag-decoration mb-3">
                        üá∫üá∏ ‚≠ê üá∫üá∏ ‚≠ê üá∫üá∏
                    </div>
                    <h2 class="fw-bold" style="color: var(--flag-blue);">
                        <i class="fas fa-user-plus"></i>
                        Register to Vote
                    </h2>
                    <p class="text-muted">
                        Create your secure account to participate in democracy
                    </p>
                </div>

                <!-- Registration Form -->
                <form method="POST" action="{{ url_for('register') }}" class="needs-validation" novalidate id="registrationForm">
                    <!-- Username Field -->
                    <div class="mb-3">
                        <label for="username" class="form-label fw-bold">
                            <i class="fas fa-user"></i>
                            Username
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="username" 
                               name="username" 
                               required
                               minlength="3"
                               maxlength="30"
                               pattern="[a-zA-Z0-9_]+"
                               autocomplete="username"
                               placeholder="Choose a unique username">
                        <div class="invalid-feedback" id="usernameFeedback">
                            Username must be 3-30 characters long and contain only letters, numbers, and underscores.
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i>
                            This will be your identifier for logging into the system
                        </div>
                    </div>

                    <!-- Password Field -->
                    <div class="mb-3">
                        <label for="password" class="form-label fw-bold">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   class="form-control" 
                                   id="password" 
                                   name="password" 
                                   required
                                   minlength="6"
                                   autocomplete="new-password"
                                   placeholder="Create a strong password">
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    id="togglePassword"
                                    aria-label="Toggle password visibility">
                                <i class="fas fa-eye" id="toggleIcon"></i>
                            </button>
                        </div>
                        <div class="invalid-feedback" id="passwordFeedback">
                            Password must meet all security requirements listed below.
                        </div>
                        
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="row g-1">
                                <div class="col">
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted" id="strengthText">Password strength: None</small>
                        </div>
                    </div>

                    <!-- Password Confirmation Field -->
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label fw-bold">
                            <i class="fas fa-lock"></i>
                            Confirm Password
                        </label>
                        <input type="password" 
                               class="form-control" 
                               id="confirm_password" 
                               name="confirm_password" 
                               required
                               autocomplete="new-password"
                               placeholder="Re-enter your password">
                        <div class="invalid-feedback" id="confirmFeedback">
                            Passwords do not match.
                        </div>
                        <div class="form-text" id="matchIndicator">
                            <i class="fas fa-times text-danger"></i>
                            Passwords must match
                        </div>
                    </div>

                    <!-- Password Requirements -->
                    <div class="mb-4 p-3" style="background-color: rgba(60, 59, 110, 0.1); border-radius: 8px;">
                        <h6 class="fw-bold mb-3" style="color: var(--flag-blue);">
                            <i class="fas fa-shield-alt"></i>
                            Password Requirements
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="requirement" id="req-length">
                                    <i class="fas fa-times text-danger"></i>
                                    <small>At least 6 characters</small>
                                </div>
                                <div class="requirement" id="req-number">
                                    <i class="fas fa-times text-danger"></i>
                                    <small>Contains a number</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="requirement" id="req-upper">
                                    <i class="fas fa-times text-danger"></i>
                                    <small>Contains uppercase letter</small>
                                </div>
                                <div class="requirement" id="req-lower">
                                    <i class="fas fa-times text-danger"></i>
                                    <small>Contains lowercase letter</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Agreement -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                        <label class="form-check-label" for="agreeTerms">
                            <i class="fas fa-gavel"></i>
                            I agree to use this voting system responsibly and understand that my vote will be encrypted and anonymous
                        </label>
                        <div class="invalid-feedback">
                            You must agree to the terms to register.
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-patriot btn-lg" id="submitBtn">
                            <i class="fas fa-user-plus"></i>
                            Create Account & Join Democracy
                        </button>
                    </div>
                </form>

                <!-- Alternative Actions -->
                <div class="text-center">
                    <hr class="my-4">
                    <p class="mb-2">
                        <i class="fas fa-question-circle"></i>
                        Already have an account?
                    </p>
                    <a href="{{ url_for('login') }}" class="btn btn-outline-primary">
                        <i class="fas fa-sign-in-alt"></i>
                        Login Instead
                    </a>
                </div>

                <!-- Security Information -->
                <div class="mt-4 p-3" style="background-color: rgba(178, 34, 52, 0.1); border-radius: 8px;">
                    <h6 class="fw-bold" style="color: var(--flag-red);">
                        <i class="fas fa-info-circle"></i>
                        Privacy & Security Commitment
                    </h6>
                    <ul class="small mb-0 list-unstyled">
                        <li><i class="fas fa-check text-success"></i> Your personal information is never shared</li>
                        <li><i class="fas fa-check text-success"></i> Passwords are encrypted with military-grade security</li>
                        <li><i class="fas fa-check text-success"></i> Your votes remain completely anonymous</li>
                        <li><i class="fas fa-check text-success"></i> No tracking or profiling of your voting patterns</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
/*
REGISTRATION PAGE JAVASCRIPT FUNCTIONALITY
==========================================

This script provides:
- Real-time password strength validation
- Password confirmation matching
- Username availability checking (client-side validation)
- Enhanced user experience features
- Security requirement tracking
*/

document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('password');
    const confirmField = document.getElementById('confirm_password');
    const usernameField = document.getElementById('username');
    const togglePassword = document.getElementById('togglePassword');
    const toggleIcon = document.getElementById('toggleIcon');
    const submitBtn = document.getElementById('submitBtn');
    
    // Password strength validation
    function validatePassword() {
        const password = passwordField.value;
        const requirements = {
            length: password.length >= 6,
            number: /\d/.test(password),
            upper: /[A-Z]/.test(password),
            lower: /[a-z]/.test(password)
        };
        
        // Update requirement indicators
        Object.keys(requirements).forEach(req => {
            const element = document.getElementById(`req-${req}`);
            const icon = element.querySelector('i');
            
            if (requirements[req]) {
                icon.className = 'fas fa-check text-success';
                element.classList.add('text-success');
                element.classList.remove('text-danger');
            } else {
                icon.className = 'fas fa-times text-danger';
                element.classList.add('text-danger');
                element.classList.remove('text-success');
            }
        });
        
        // Calculate strength percentage
        const metRequirements = Object.values(requirements).filter(Boolean).length;
        const strengthPercent = (metRequirements / 4) * 100;
        
        // Update progress bar
        const progressBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        
        progressBar.style.width = strengthPercent + '%';
        
        if (strengthPercent === 0) {
            progressBar.className = 'progress-bar';
            strengthText.textContent = 'Password strength: None';
        } else if (strengthPercent < 50) {
            progressBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Password strength: Weak';
        } else if (strengthPercent < 100) {
            progressBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Password strength: Good';
        } else {
            progressBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Password strength: Strong';
        }
        
        return Object.values(requirements).every(Boolean);
    }
    
    // Password confirmation matching
    function validatePasswordMatch() {
        const password = passwordField.value;
        const confirm = confirmField.value;
        const matchIndicator = document.getElementById('matchIndicator');
        
        if (confirm.length === 0) {
            matchIndicator.innerHTML = '<i class="fas fa-times text-danger"></i> Passwords must match';
            return false;
        } else if (password === confirm) {
            matchIndicator.innerHTML = '<i class="fas fa-check text-success"></i> Passwords match';
            matchIndicator.className = 'form-text text-success';
            return true;
        } else {
            matchIndicator.innerHTML = '<i class="fas fa-times text-danger"></i> Passwords do not match';
            matchIndicator.className = 'form-text text-danger';
            return false;
        }
    }
    
    // Username formatting
    function formatUsername() {
        if (usernameField) {
            usernameField.value = usernameField.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
        }
    }
    
    // Event listeners
    if (passwordField) {
        passwordField.addEventListener('input', function() {
            validatePassword();
            if (confirmField.value) validatePasswordMatch();
        });
    }
    
    if (confirmField) {
        confirmField.addEventListener('input', validatePasswordMatch);
    }
    
    if (usernameField) {
        usernameField.addEventListener('input', formatUsername);
    }
    
    // Password visibility toggle
    if (togglePassword && passwordField && toggleIcon) {
        togglePassword.addEventListener('click', function() {
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            
            if (type === 'password') {
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            } else {
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            }
        });
    }
    
    // Form submission validation
    const form = document.getElementById('registrationForm');
    if (form) {
        form.addEventListener('submit', function(event) {
            const isPasswordValid = validatePassword();
            const isPasswordMatch = validatePasswordMatch();
            
            if (!isPasswordValid || !isPasswordMatch || !form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                // Focus on first invalid field
                const firstInvalid = form.querySelector(':invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                }
            } else {
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                submitBtn.disabled = true;
            }
            
            form.classList.add('was-validated');
        });
    }
    
    // Auto-focus on username field
    if (usernameField && !usernameField.value) {
        usernameField.focus();
    }
    
    console.log('üá∫üá∏ Registration page loaded - Ready for new voter registration');
});

// Add custom CSS for better UX
const style = document.createElement('style');
style.textContent = `
    .requirement {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }
    
    .requirement i {
        width: 16px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: var(--flag-red);
        box-shadow: 0 0 0 0.2rem rgba(178, 34, 52, 0.25);
    }
    
    .progress {
        transition: all 0.3s ease;
    }
    
    .progress-bar {
        transition: all 0.3s ease;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
